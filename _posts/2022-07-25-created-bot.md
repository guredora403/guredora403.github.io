---
title: 毎日夏休みの残り日数をツイートする謎のBOTを作った
tags: tech 開発
layout: post
description: 夏休みはあっという間です。すこしでも危機感を持てるように毎日残り日数をツイートするBOTを作りました。
---
# 夏休みすぐ終わっちゃう
みなさんこんにちは。私は夏休みが始まってしまいました。

高３の夏休みとても重要ではありますが、普通に過ごしてると日付感覚がわからなくなるものです。

気が付いたら夏休みが終わっちゃったなんてこともあり得ます。恐ろしや。

というわけで、毎日夏休みの残り日数がわかるように、かってにツイートするTwitter BOTを作りました。

名付けて「夏休みカウンター」です。そのままですね。

「なんでツイッターなんだ」とか「カレンダーアプリでいいじゃないか」とか言われそうですが、twitterなら毎日多少見ると思うので一番確実性があると思われます。きっと。

きっと誰かの役にも立つでしょう。

初めてHerokuを使ったりとかしたので一応記録として残しておきます。

# 何はともあれtwitterのAPIキーを入手
これをしないと始まりません。

ツイートできればいいので、API v2で十分です。
詳しい記事はたくさんあるので、詳細は割愛します。

それから、初期設定だとAPPのpermissionがreadになっているのですが、read and writeじゃないとツイートができないので変更します。
変更にめちゃくちゃ手間取ったのでメモしておきます。

変更するにはOauthの初期設定が必要なようです。APPの画面を開き、settingsタブを選択します。

下の方にOauthがセットアップされてないという内容のメッセージが出てくるので、指示に従って設定します。この時、Oauthのバージョンで1.1を選ぶとpermissionを選ぶラジオボタンが出現します。

初期設定が必要なことにしばらく気づかなくて、どこからpermissionを変更するのか１時間ぐらい探し回ってました。自分のアカウントをいじるだけならOauthの設定いらないと思ったんですが。

設定を保存したら、APIキーなどの情報をregenerateします。

consumerKeyとconsumerSecret、それからaccessTokenとaccessTokenSecretをメモしておきます。

# コーディング
今回はpythonとtweepyでさくっと行きます。
事前にtweepyのインストールが必要です。

```cmd
pip install tweepy
```

コードは以下の通り。

```python
import tweepy
from datetime import date
import sys

CONSUMER_KEY = "<consumerKey>"
CONSUMER_SECRET = "<consumerSecret>"
ACCESS_TOKEN = "<accessToken>"
ACCESSTOKEN_SECRET = "<accessTokenSecret>"

start_date = date(2022, 9, 1) #始業日の日付
today = date.today()
if today > start_date:
	#始業日を過ぎているので終了
	sys.exit()
message = ""
date_def = start_date - today
message += "夏休みの残り日数は%d日です！\n" % (date_def.days)
auth = tweepy.OAuthHandler(CONSUMER_KEY, CONSUMER_SECRET)
auth.set_access_token(ACCESS_TOKEN, ACCESSTOKEN_SECRET)
api = tweepy.API(auth)
api.update_status(message)
print("done!")
```

現在の日付から９月一日までの差分を求めてツイートするだけです。
ずっと動き続けられてもこまるので、始業日が過ぎたら止まるようにしています。

定数にTwitterから取ってきたAPIの情報を入れると動くはずです。


# 定期実行させる
ツイートするコードは書けましたが、これを定期実行してやる必要があります。

パソコンのタスクスケジューラでも良いじゃないかとか聞こえてきそうですが、パソコンが常時起動していてインターネットに接続されていることが求められるのであまり気分がよくないです。余計なところに気を使いたくありません。

VPSでも持ってたらcronするだけなのですが、そんなものはありません。金もかけたくないし。

いろいろ調べたら、[Heroku](https://heroku.com)のアドーンにHeroku Schedulerを見つけました。Heroku上のコマンドを定期実行してくれるアドーンです。

これを使えばHerokuにデプロイして、定期実行できます。これならpythonも動きますし、こちらの環境を気にしなくてもよくなります。素晴らしい！

まあ、ここまですることに意味はあるのかとか思わないこともないですが、こういうのは自己満足です。


# Herokuのセットアップ
使うの初めてなのでいろいろ設定していきます。


## Herokuに登録
まずはアカウント作成からです。面倒ですが、きっと何かの役に立つでしょう。

Herokuにアクセスし、氏名、メールアドレス、その他もろもろ、言われたものを入力します。

とくに問題なく登録できました。

## クレジットカードを登録
アドーンの利用にはクレカの登録が必要らしいので登録しました。
住所も入れなきゃいけないので正直面倒でした。

アカウント設定から登録できます。

ちなみに住所は、英語のページだったので英語で入れなきゃいけないのかなと思ったら、日本語で入れないとエラーになりました。

これで無料枠も拡大するみたいです。今回はHeroku Schedulerを使うために必要だったので登録しました。

この作業をしているのは午前２時。私はここで力尽きました。寝ます。おやすみなさい。腹減った。


## Heroku CLIのインストール
おはようございます！良い朝？昼？まあ、夏休みの生活リズムなんて気にしてはいけません！

Heroku CLIをインストールします。今回はChocolateyを使います。

管理者権限でコマンドプロンプトを立ち上げます。

```cmd
choco install heroku-cli
```

インストールはこれだけです。

なんかgitが再インストールされました。汚されたくないならおとなしくインストーラ落としてきたほうがいいかも。

chocolatey、便利です。

## ログイン
Heroku CLIで作ったアカウントにログインします。

```cmd
heroku login
```

何かキーを押すとブラウザが起動します。ログイン済みであれば、ログインボタンを押すだけで完了しました。

# デプロイ準備
Herokuにデプロイする準備や設定をしていきます。

## 作業ディレクトリ作成
まず、どこでもいいので作業ディレクトリを作り、移動します。

```cmd
mkdir summer-vacation-counter
cd summer-vacation-counter
```

## gitリポジトリ初期化
デプロイに必要なのでgitリポジトリを初期化します。

```cmd
git init
```


## Herokuにアプリを作成
Herokuにアプリを作成します。アプリ名は何でもよいです。

```cmd
heroku create summer-vacation-counter
```

こうするとherokuという名前のgitリモートリポジトリが追加されます。
`git push heroku master`でデプロイできるようです。すごい連携だ。

## タイムゾーンの設定
タイムゾーンを日本に合わせます。
時間が絡むBOTなので、タイムゾーンは重要です。

初期設定はUTCになってました。

```
heroku config:add TZ=Asia/Tokyo
```

`heroku run date`でJSTになっていれば成功です。

## ファイルを配置
必要なファイルを作業ディレクトリの直下に配置します。

まずはツイートするコードを「main.py」として保存します。先ほどというか昨日作ったやつです。

次に、「runtime.txt」というファイルを作成します。ここにはpythonのバージョンを記述するみたいです。
内容は以下のようにしました。

```
python-3.8.7
```

バージョンは動けばなんでも良いと思うのですが、自分の環境に合わせて3.8.7にしておきました。

最後にrequirements.txtを作成します。これは必要なpipパッケージを書いておくファイルですね。おなじみです。

今回はtweepyしか使わないので、内容は以下のようになりました。

```
tweepy
```

これで必要な作業は終わりのはずです。

# デプロイ
デプロイします。

```cmd
git add .
git commit -m "initial commit"
git push heroku master
```

すげ。remoteでこんなにメッセージ出てくるのか。
githubしか使ったことなかったので、pushしたときにこんなにメッセージ帰ってくるのは初めて見ました。

結果にはいろいろインストールが完了したようなことが書いてありました。おそらく成功した気がします。

# 動作確認
`heroku run python main.py`で動作確認ができます。

無事ツイートされて動いていることが確認できました！やったね！

# 定期実行を設定する
ここまで長かったですが、後すこしだと信じてます。

## heroku schedulerアドーンを追加
アプリに[Heroku Schedulerアドーン](https://elements.heroku.com/addons/scheduler)を追加します。
上記のリンクからでも追加できますが、今回はCLIを使います。

先ほどの作業ディレクトリでこのコマンドを実行します。

```cmd
heroku addons:create scheduler:standard
```

「Created scheduler…」と表示されれば追加は完了です。

## 定期実行の設定
` heroku addons:open scheduler`を実行すると、ブラウザが立ち上がり管理画面が表示されます。

「Create job」を押すと、実行タイミングの設定画面が表示されるのですが、タイムゾーンがUTCになっています。
どうやらアプリ自体のタイムゾーンとは同期してないみたいです。

仕方がないので、UTCで設定します。日本時間の毎朝８時３０分に実行したいので、

９時間引いて前の日の２３時半ということになります。

あれ？前の日？

いや。関係ないですね。UTCが前のひなだけで、プログラム自体はちゃんとした日付を取ってくるはずです。うん。
時差難しい。

とにかく、２３時半の毎日実行で設定しました。

Dyno Sizeは標準です。そんなに重い処理ではないので。

# できた！
長かったのか？うーん。それなりに長かったですね。

TwitterのAPIキーの入手にめちゃくちゃ手間取ったこと以外はおおむね順調でした。ああいう系のAPIの登録って結構惑わされますよね。いつもやりかた忘れるし。

TwitterのAPIキーがハードコーディングされてるのはいかがなものかと思ったりしますが、どこでも動かせるしいいんじゃないですかね。

なんでただの記録がこんな長文になってしまったんだか。多分Herokuの導入なんてしなければこんなことにはならなかったはずなのに。

それにしてもHerokuってよくできてますね。感動です。あれで無料だし。前からどんなものか知ってはいましたが、まさか定期実行までできるとは思ってませんでした。
またお世話になりそうです。

あ。それと、残りの日数によってメッセージが変化する小細工をしておきました。動くかは知りません。

うーん。もうすこし遅い時間の方がよかったかな。８時半なんて絶対起きてない気がするし。

まあいいでしょう。どうやら始業日まであと３８日とかあるらしいので頑張っていきますかね。

ではでは。皆さんも頑張ってください。

大長文しつれいしました。

以上。
